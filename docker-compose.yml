version: '3'

volumes:
  prometheus-data:
  grafana-data:

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - prometheus-data:/prometheus
    restart: unless-stopped
    entrypoint:
      - /bin/sh
      - -c
      - |
        mkdir -p /etc/prometheus
        cat > /etc/prometheus/prometheus.yml << 'EOL'
        global:
          scrape_interval: 15s
          evaluation_interval: 15s

        scrape_configs:
          - job_name: "prometheus"
            static_configs:
              - targets: ["localhost:9090"]

          - job_name: "node_exporter"
            static_configs:
              - targets: ["node_exporter:9100"]

          - job_name: "cadvisor"
            static_configs:
              - targets: ["cadvisor:8080"]
        EOL
        
        # Create basic auth file
        mkdir -p /etc/prometheus
        touch /etc/prometheus/web.yml
        cat > /etc/prometheus/web.yml << 'EOL'
        basic_auth_users:
          admin: $2y$10$zr7pLh1xDCMWVCnL6LsLkO7eo47AN91aMkRxQgPOIcMH9iAGNzTZK
        
        tls_server_config:
          cipher_suites:
            - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
            - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
            - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
            - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
          min_version: TLS12
        
        http_server_config:
          http2: true
          headers:
            Content-Security-Policy: "default-src 'self'"
            X-Content-Type-Options: "nosniff"
            X-Frame-Options: "deny"
            X-XSS-Protection: "1; mode=block"
          cors_origins: []  # Empty list disables CORS
        
        # IP-based access control settings
        tls_client_auth:
          enabled: false
          
        # IP filtering configuration
        remote_write:
          address_filter:
            accept:
              - "127.0.0.1/8"  # localhost
              - "10.0.0.0/8"    # private range
              - "172.16.0.0/12" # private range
              - "192.168.0.0/16" # private range
              - "57.128.64.89/32" # example specific external IP
            reject:
              - "0.0.0.0/0"    # reject all other IPs
        EOL
        
        /bin/prometheus --config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/prometheus --web.config.file=/etc/prometheus/web.yml --web.listen-address=0.0.0.0:9090

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3001:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    restart: unless-stopped
    entrypoint:
      - /bin/bash
      - -c
      - |
        mkdir -p /etc/grafana/provisioning/datasources
        cat > /etc/grafana/provisioning/datasources/datasource.yml << 'EOL'
        apiVersion: 1

        datasources:
          - name: Prometheus
            type: prometheus
            access: proxy
            url: http://prometheus:9090
            isDefault: true
            editable: true
        EOL
        
        mkdir -p /var/lib/grafana/dashboards
        cat > /var/lib/grafana/dashboards/default.json << 'EOL'
        {
          "annotations": {
            "list": []
          },
          "editable": true,
          "gnetId": null,
          "graphTooltip": 0,
          "links": [],
          "panels": [
            {
              "datasource": "Prometheus",
              "description": "System load average",
              "fieldConfig": {
                "defaults": {
                  "color": {
                    "mode": "palette-classic"
                  },
                  "custom": {
                    "axisLabel": "",
                    "axisPlacement": "auto",
                    "barAlignment": 0,
                    "drawStyle": "line",
                    "fillOpacity": 10,
                    "gradientMode": "none",
                    "hideFrom": {
                      "legend": false,
                      "tooltip": false,
                      "viz": false
                    },
                    "lineInterpolation": "linear",
                    "lineWidth": 1,
                    "pointSize": 5,
                    "scaleDistribution": {
                      "type": "linear"
                    },
                    "showPoints": "never",
                    "spanNulls": false
                  },
                  "mappings": [],
                  "thresholds": {
                    "mode": "absolute",
                    "steps": [
                      {
                        "color": "green",
                        "value": null
                      },
                      {
                        "color": "red",
                        "value": 80
                      }
                    ]
                  },
                  "unit": "none"
                },
                "overrides": []
              },
              "gridPos": {
                "h": 8,
                "w": 12,
                "x": 0,
                "y": 0
              },
              "id": 1,
              "options": {
                "legend": {
                  "calcs": [],
                  "displayMode": "list",
                  "placement": "bottom"
                },
                "tooltip": {
                  "mode": "single"
                }
              },
              "pluginVersion": "8.0.0",
              "targets": [
                {
                  "exemplar": true,
                  "expr": "node_load1",
                  "interval": "",
                  "legendFormat": "1m",
                  "refId": "A"
                },
                {
                  "exemplar": true,
                  "expr": "node_load5",
                  "interval": "",
                  "legendFormat": "5m",
                  "refId": "B"
                },
                {
                  "exemplar": true,
                  "expr": "node_load15",
                  "interval": "",
                  "legendFormat": "15m",
                  "refId": "C"
                }
              ],
              "title": "System Load Average",
              "type": "timeseries"
            }
          ],
          "refresh": "5s",
          "schemaVersion": 30,
          "style": "dark",
          "tags": [],
          "templating": {
            "list": []
          },
          "time": {
            "from": "now-1h",
            "to": "now"
          },
          "timepicker": {},
          "timezone": "",
          "title": "Default Dashboard",
          "version": 1
        }
        EOL
        
        cat > /etc/grafana/grafana.ini << 'EOL'
        [dashboards]
        default_home_dashboard_path = /var/lib/grafana/dashboards/default.json
        EOL
        
        /run.sh

  node_exporter:
    image: quay.io/prometheus/node-exporter:latest
    container_name: node_exporter
    command:
      - '--path.rootfs=/host'
    pid: host
    restart: unless-stopped
    volumes:
      - '/:/host:ro,rslave'

  cadvisor:
    image: google/cadvisor:latest
    container_name: cadvisor
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    devices:
      - /dev/kmsg
    restart: unless-stopped